<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan | Tiexin Guo</title><meta name=keywords content="devsecops,ci"><meta name=description content="This blog post is first published at GitGuardian blog. Disclaimer: this tutorial goes all the way through setting up Jenkins in a Kubernetes minikube cluster, if you&rsquo;re only interested in the Jenkinsfile, jump to the last part! 0 GitGuardian and ggshield ggshield is a CLI application that runs in your local environment or in a CI environment to help you detect more than 350 types of secrets, as well as"><meta name=author content="Tiexin Guo | ÈÉ≠ÈìÅÂøÉ"><link rel=canonical href=https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.guotiexin.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.guotiexin.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.guotiexin.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.guotiexin.com/apple-touch-icon.png><link rel=mask-icon href=https://www.guotiexin.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan"><meta property="og:description" content="This blog post is first published at GitGuardian blog. Disclaimer: this tutorial goes all the way through setting up Jenkins in a Kubernetes minikube cluster, if you&rsquo;re only interested in the Jenkinsfile, jump to the last part! 0 GitGuardian and ggshield ggshield is a CLI application that runs in your local environment or in a CI environment to help you detect more than 350 types of secrets, as well as"><meta property="og:type" content="article"><meta property="og:url" content="https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/"><meta property="og:image" content="https://www.guotiexin.com/22W16-blog-how-to-setup.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-12T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-12T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.guotiexin.com/22W16-blog-how-to-setup.png"><meta name=twitter:title content="How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan"><meta name=twitter:description content="This blog post is first published at GitGuardian blog. Disclaimer: this tutorial goes all the way through setting up Jenkins in a Kubernetes minikube cluster, if you&rsquo;re only interested in the Jenkinsfile, jump to the last part! 0 GitGuardian and ggshield ggshield is a CLI application that runs in your local environment or in a CI environment to help you detect more than 350 types of secrets, as well as"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.guotiexin.com/posts/"},{"@type":"ListItem","position":3,"name":"How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan","item":"https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan","name":"How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan","description":"This blog post is first published at GitGuardian blog. Disclaimer: this tutorial goes all the way through setting up Jenkins in a Kubernetes minikube cluster, if you\u0026rsquo;re only interested in the Jenkinsfile, jump to the last part! 0 GitGuardian and ggshield ggshield is a CLI application that runs in your local environment or in a CI environment to help you detect more than 350 types of secrets, as well as","keywords":["devsecops","ci"],"articleBody":"This blog post is first published at GitGuardian blog.\nDisclaimer: this tutorial goes all the way through setting up Jenkins in a Kubernetes minikube cluster, if you‚Äôre only interested in the Jenkinsfile, jump to the last part!\n0 GitGuardian and ggshield ggshield is a CLI application that runs in your local environment or in a CI environment to help you detect more than 350 types of secrets, as well as other potential security vulnerabilities or policy breaks.\nThe tool uses GitGuardian‚Äôs API, more specifically, it will require a service account to set up Jenkins. Service accounts are only available for workspaces under our Business plan and only workspace Managers are allowed to manage service account tokens.\nüí° If you‚Äôd like to learn more about how GitGuardian detects secrets and why it does it well, read about its state-of-the-art secrets detection engine.\nIn this tutorial, we will show how to run one of the most famous CI tools that is Jenkins, in a Kubernetes cluster, and how to integrate ggshield with it as a neat declarative pipeline step (with a bonus: how to add Docker image scanning).\nNote: if using GitHub Actions, it‚Äôs actually quite easy to integrate ggshield as part of your workflow using GitGuardian‚Äôs official gg-shield-action. Actually, I‚Äôve already done a tutorial covering exactly that!\nAfter reading this tutorial, you will be able to:\ninstall Jenkins in a Kubernetes cluster; integrate Jenkins/Kubernetes/GitGuardian together; scan your repo for secrets leak with ggshield in a Jenkins pipeline running in a Kubernetes pod; scan a Docker image in your Jenkins pipeline. Without further ado, let‚Äôs get started. 1 Preparing a K8s Cluster If you don‚Äôt already have a K8s cluster yet, follow this section; otherwise, jump to the next.\nWe will use minikube, which is a tool that creates a single-node Kubernetes cluster on your computer. For Mac users, you can easily run:\nbrew install minikube to install minikube. For other operating systems users, refer to the official doc.\nOnce minikube is installed, you can create a minikube cluster by entering the following command:\nminikube start Once the cluster has been created, you can verify its status by entering:\nminikube status 2 Running Jenkins in K8s 2.1 Create a namespace A distinct namespace provides an additional layer of isolation and more control over the continuous integration environment.\nCreate a namespace for the Jenkins deployment by typing the following command on your terminal:\nkubectl create namespace jenkins 2.2 Create a Persistent Volume We want to create a persistent volume for our Jenkins controller pod (we choose the /data directory). This will prevent us from losing our whole Jenkins controller configuration and jobs when we reboot our minikube.\nIn a multi-node Kubernetes cluster, you‚Äôll need some solution like NFS to make the mount directory available in the whole cluster. But because we use minikube, which is a one-node cluster, we don‚Äôt have to bother about it. We choose to use the /data directory. This directory will contain our Jenkins controller configuration.\nWe will create a volume which is called jenkins-pv. Create a file jenkins-volume.yaml based on the content here, and apply it:\nkubectl apply -f jenkins-volume.yaml Note 1: in the above spec, hostPath uses the /data/jenkins-volume/ of your node to emulate network-attached storage. This approach is only suited for development and testing purposes. For production, you should provide a network resource like a Google Compute Engine persistent disk or an Amazon Elastic Block Store volume.\nNote 2: minikube configured for hostPath sets the permissions on /data to the root account only. Once the volume is created, you will need to manually change the permissions to allow the Jenkins account to write its data by running:\nminikube ssh sudo chown -R 1000:1000 /data/jenkins-volume At this exact moment, if you have been following the tutorial exactly, the /data folder has been created, but not the /data/jenkins-volume. You might want to return to this step again after helm install in the next section.\n2.3 Install Jenkins with Helm From there you need Helm CLI, if you don‚Äôt already have it follow the instructions from the Installing Helm page.\nFirst, let‚Äôs create the required service accounts:\nCreate a file jenkins-sa.yaml based on the content here, and apply it:\nkubectl apply -f jenkins-sa.yaml Next, we prepare a values.yaml file based on the content here, and install Jenkins with helm using the values file:\nhelm repo add jenkinsci https://charts.jenkins.io helm repo update helm upgrade --install jenkins -n jenkins -f values.yaml jenkinsci/jenkins 2.4 Login to Jenkins After the installation, to get the default password for your Jenkins admin user, run:\njsonpath=\"{.data.jenkins-admin-password}\" secret=$(kubectl get secret -n jenkins jenkins -o jsonpath=$jsonpath) echo $(echo $secret | base64 --decode) The username is admin.\nTo login, let‚Äôs first port-forward the Jenkins service to our localhost:\nkubectl port-forward svc/jenkins 8080 And now you can open a browser tab and log in by visiting http://localhost:8080/login with the admin user.\nFor production usage, you may need to add an ingress and serve it with HTTPS.\n3 Jenkins-GitGuardian-Kubernetes Connection 3.1 Creating a GitGuardian API Key Go to the Service accounts page in the API section of your workspace. Click on Create service account.\nName your service account according to its use case (for example in this case jenkins-test) Set an expiry date for your token (in 1 week, 1 month, 6 months, 1 year, or never). If an expiry date is set, all the Managers of the workspace will receive an email notification 5 days before expiration. Choose one or several scopes for your service account. Click on Create service account Make sure you copy the service account, it will no longer be visible to you in the future. We‚Äôre going to put it in a Jenkins credential:\n3.2 Making Sure Jenkins-Kubernetes Integration Works Fine Go to Jenkins -\u003e Manage Jenkins -\u003e Manage Nodes and Clouds -\u003e Configure Clouds, click ‚ÄúKubernetes Cloud Details‚Ä¶‚Äù, and test the connection. This should succeed by default since it‚Äôs the same cluster where our Jenkins lives.\n4 Declarative Pipelines with ggshield After all these preparations, it‚Äôs time for the important stuff: let‚Äôs create a Jenkins job and give it a try! Go to Jenkins, click ‚ÄúNew Item‚Äù, and create an item of type ‚Äúpipeline‚Äù.\nAnd in the ‚Äúpipeline definition‚Äù part, copy the content below:\npodTemplate(containers: [ containerTemplate(name: 'ggshield', image: 'gitguardian/ggshield:latest', command: 'sleep', args: '99d', runAsUser: '1000')]) { node(POD_LABEL) { stage('Get a project') { git url:'https://github.com/IronCore864/k8s-vagrant-kubeadm.git', branch: 'main' container('ggshield') { stage('Scan a project') { withCredentials( [string(credentialsId: 'gitguardian-api-key', variable:'GITGUARDIAN_API_KEY')]) { sh 'ggshield scan repo .' } } } } } } For this demo, we‚Äôll scan an existing GitHub repository. Some details about this pipeline definition:\nwe declare a podTemplate to use in the Kubernetes plugin. we override the command with args so that the container won‚Äôt quit immediately after it‚Äôs started (because by default, the gitguardian/ggshield image starts with the command directly). we also specify under which user the ggshield container is running with the runAsUser parameter (because by default, ggshield runs under user 1337 and Jenkins JNLP runs with user 1000; so there might be some problems for multi-container pods to access shared files, like the cloned git repo). we use withCredentials so that the gitguardian-api-key Jenkins credentials we created earlier will be used as an environment variable for our ggshield CLI tool. Let‚Äôs give it a try: As we can see, it successfully detected a possible leak that looks like an API key; and it is! Because it‚Äôs a hard-coded token for Kubernetes.\n5 Docker Image Scanning with Jenkins Pipeline To scan a docker image with ggshield, we can simply run the following command in our CI pipelines:\nggshield scan docker REPOOWNER/IMAGEREPO To add ggshield docker image scan to your pipelines, configure your Jenkinsfile to add a ggshield stage which scans an image:\nstage('Get a project') { container('ggshield') { stage('Scan an image') { withCredentials([string(credentialsId: 'gitguardian-api-key', variable: 'GITGUARDIAN_API_KEY')]) { sh 'ggshield scan docker REPOOWNER/IMAGEREPO' } } } } Similar to the above, do not forget to add your GitGuardian API Key to the gitguardian-api-key credential in your project settings.\nüí° Due to our setup (local virtualized K8s with Jenkins running as a pod in the cluster), it‚Äôs tricky to create a VM and use that VM as a Jenkins worker to join the Jenkins cluster. So we will not demonstrate this part in this tutorial. In an ideal production-grade setup, we can easily create a Jenkins worker node on a virtual machine for docker images related tasks and pipelines. Due to the length of this article, we will not include this part as part of the tutorial. If you are interested, see the official documentation on Jenkins agents.\n6 Summary With containerized Jenkins in Kubernetes, we get to use the CI that we are already familiar with, without the need to migrate to another CI, and we are running it in modern and immutable infrastructure (hence much easier to manage and much less overhead).\nWith declarative job descriptions, we get what you write, and we use the pipeline code as the single source of truth of the job.\nWith ggshield automated with all the benefits above, we are genuinely achieving DevSecOps.\nIf you like this tutorial and want to see more, please like, comment, and subscribe. See you next time!\n","wordCount":"1544","inLanguage":"en","image":"https://www.guotiexin.com/22W16-blog-how-to-setup.png","datePublished":"2022-05-12T00:00:00Z","dateModified":"2022-05-12T00:00:00Z","author":{"@type":"Person","name":"Tiexin Guo | ÈÉ≠ÈìÅÂøÉ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/"},"publisher":{"@type":"Organization","name":"Tiexin Guo","logo":{"@type":"ImageObject","url":"https://www.guotiexin.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.guotiexin.com accesskey=h title="Tiexin Guo (Alt + H)">Tiexin Guo</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.guotiexin.com/about title=About><span>About</span></a></li><li><a href=https://cv.guotiexin.com/ title=CV><span>CV</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.guotiexin.com/portfolio title=Portfolio><span>Portfolio</span></a></li><li><a href=https://www.guotiexin.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://www.guotiexin.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://www.guotiexin.com/posts/ title=Archive><span>Archive</span></a></li><li><a href=https://github.com/ironcore864 title><span><i class='fab fa-github fa-fw'></i></span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan</h1><div class=post-meta><span title='2022-05-12 00:00:00 +0000 UTC'>May 12, 2022</span>&nbsp;¬∑&nbsp;Tiexin Guo | ÈÉ≠ÈìÅÂøÉ</div></header><figure class=entry-cover><img loading=lazy srcset="https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup_hu93d75e5f26be3d366af8a3272fc190c2_111637_360x0_resize_box_3.png 360w ,https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup_hu93d75e5f26be3d366af8a3272fc190c2_111637_480x0_resize_box_3.png 480w ,https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup_hu93d75e5f26be3d366af8a3272fc190c2_111637_720x0_resize_box_3.png 720w ,https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup_hu93d75e5f26be3d366af8a3272fc190c2_111637_1080x0_resize_box_3.png 1080w ,https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup_hu93d75e5f26be3d366af8a3272fc190c2_111637_1500x0_resize_box_3.png 1500w ,https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup.png 2360w" sizes="(min-width: 768px) 720px, 100vw" src=https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup.png alt=devsecops width=2360 height=1380></figure><div class=post-content><p><em>This blog post is first published at <a href=https://blog.gitguardian.com/how-to-setup-jenkins-with-gitguardian-kubernetes/>GitGuardian blog</a>.</em></p><p><strong>Disclaimer</strong>: this tutorial goes all the way through <strong>setting up Jenkins in a Kubernetes minikube cluster</strong>, if you&rsquo;re only interested in the <strong>Jenkinsfile</strong>, jump to the last part!</p><hr><h2 id=0-gitguardian-and-ggshield>0 GitGuardian and ggshield<a hidden class=anchor aria-hidden=true href=#0-gitguardian-and-ggshield>#</a></h2><p><a href=https://github.com/GitGuardian/ggshield>ggshield</a> is a CLI application that runs in your local environment or in a CI environment to help you detect more than 350 types of secrets, as well as other potential security vulnerabilities or policy breaks.</p><p>The tool uses GitGuardian&rsquo;s API, more specifically, it will require a service account to set up Jenkins. Service accounts are only available for workspaces under our Business plan and only workspace Managers are allowed to manage service account tokens.</p><blockquote><p>üí° If you&rsquo;d like to learn more about how GitGuardian detects secrets and why it does it well, read about its state-of-the-art <a href=https://docs.gitguardian.com/secrets-detection/quick_start>secrets detection engine</a>.</p></blockquote><p>In this tutorial, we will show how to run one of the most famous CI tools that is <strong>Jenkins</strong>, in a Kubernetes cluster, and how to integrate ggshield with it as a neat declarative pipeline step (with a <strong>bonus</strong>: how to add Docker image scanning).</p><p><strong>Note</strong>: if using GitHub Actions, it&rsquo;s actually quite easy to integrate ggshield as part of your workflow using GitGuardian&rsquo;s official gg-shield-action. Actually, I&rsquo;ve already done a tutorial covering exactly that!</p><p>After reading this tutorial, you will be able to:</p><ul><li>install Jenkins in a Kubernetes cluster;</li><li>integrate Jenkins/Kubernetes/GitGuardian together;</li><li>scan your repo for secrets leak with <code>ggshield</code> in a Jenkins pipeline running in a Kubernetes pod;</li><li>scan a Docker image in your Jenkins pipeline.
Without further ado, let&rsquo;s get started.</li></ul><hr><h2 id=1-preparing-a-k8s-cluster>1 Preparing a K8s Cluster<a hidden class=anchor aria-hidden=true href=#1-preparing-a-k8s-cluster>#</a></h2><p>If you don&rsquo;t already have a K8s cluster yet, follow this section; otherwise, jump to the next.</p><p>We will use <code>minikube</code>, which is a tool that creates a single-node Kubernetes cluster on your computer. For Mac users, you can easily run:</p><pre tabindex=0><code>brew install minikube
</code></pre><p>to install <code>minikube</code>. For other operating systems users, refer to the <a href=https://minikube.sigs.k8s.io/docs/start/>official doc</a>.</p><p>Once <code>minikube</code> is installed, you can create a <code>minikube</code> cluster by entering the following command:</p><pre tabindex=0><code>minikube start
</code></pre><p>Once the cluster has been created, you can verify its status by entering:</p><pre tabindex=0><code>minikube status
</code></pre><hr><h2 id=2-running-jenkins-in-k8s>2 Running Jenkins in K8s<a hidden class=anchor aria-hidden=true href=#2-running-jenkins-in-k8s>#</a></h2><h3 id=21-create-a-namespace>2.1 Create a namespace<a hidden class=anchor aria-hidden=true href=#21-create-a-namespace>#</a></h3><p>A distinct namespace provides an additional layer of isolation and more control over the continuous integration environment.</p><p>Create a namespace for the Jenkins deployment by typing the following command on your terminal:</p><pre tabindex=0><code>kubectl create namespace jenkins
</code></pre><h3 id=22-create-a-persistent-volume>2.2 Create a Persistent Volume<a hidden class=anchor aria-hidden=true href=#22-create-a-persistent-volume>#</a></h3><p>We want to create a persistent volume for our Jenkins controller pod (we choose the /data directory). This will prevent us from losing our whole Jenkins controller configuration and jobs when we reboot our <code>minikube</code>.</p><p>In a multi-node Kubernetes cluster, you‚Äôll need some solution like NFS to make the mount directory available in the whole cluster. But because we use <code>minikube</code>, which is a one-node cluster, we don‚Äôt have to bother about it. We choose to use the <code>/data</code> directory. This directory will contain our Jenkins controller configuration.</p><p>We will create a volume which is called <code>jenkins-pv</code>. Create a file <code>jenkins-volume.yaml</code> based on the content here, and apply it:</p><pre tabindex=0><code>kubectl apply -f jenkins-volume.yaml
</code></pre><p><em>Note 1: in the above spec, hostPath uses the <code>/data/jenkins-volume/</code> of your node to emulate network-attached storage. <strong>This approach is only suited for development and testing purposes</strong>. For production, you should provide a network resource like a Google Compute Engine persistent disk or an Amazon Elastic Block Store volume.</em></p><p><em>Note 2: <code>minikube</code> configured for hostPath sets the permissions on <code>/data</code> to the root account only. Once the volume is created, you will need to manually change the permissions to allow the Jenkins account to write its data by running:</em></p><pre tabindex=0><code>minikube ssh
sudo chown -R 1000:1000 /data/jenkins-volume
</code></pre><p>At this exact moment, if you have been following the tutorial exactly, the <code>/data</code> folder has been created, but not the <code>/data/jenkins-volume</code>. You might want to return to this step again after <code>helm install</code> in the next section.</p><h3 id=23-install-jenkins-with-helm>2.3 Install Jenkins with Helm<a hidden class=anchor aria-hidden=true href=#23-install-jenkins-with-helm>#</a></h3><blockquote><p>From there you need Helm CLI, if you don&rsquo;t already have it follow the instructions from the <a href=https://helm.sh/docs/intro/install/>Installing Helm</a> page.</p></blockquote><p>First, let&rsquo;s create the required service accounts:</p><p>Create a file <code>jenkins-sa.yaml</code> based on the <a href=https://github.com/IronCore864/jenkins-ggshield-tutorial/blob/main/values.yaml>content here</a>, and apply it:</p><pre tabindex=0><code>kubectl apply -f jenkins-sa.yaml
</code></pre><p>Next, we prepare a <code>values.yaml</code> file based on the <a href=https://github.com/IronCore864/jenkins-ggshield-tutorial/blob/main/values.yaml>content here</a>, and install Jenkins with helm using the values file:</p><pre tabindex=0><code>helm repo add jenkinsci https://charts.jenkins.io
helm repo update
helm upgrade --install jenkins -n jenkins -f values.yaml jenkinsci/jenkins
</code></pre><h3 id=24-login-to-jenkins>2.4 Login to Jenkins<a hidden class=anchor aria-hidden=true href=#24-login-to-jenkins>#</a></h3><p>After the installation, to get the default password for your Jenkins admin user, run:</p><pre tabindex=0><code>jsonpath=&#34;{.data.jenkins-admin-password}&#34;
secret=$(kubectl get secret -n jenkins jenkins -o jsonpath=$jsonpath)
echo $(echo $secret | base64 --decode)
</code></pre><p>The username is admin.</p><p>To login, let&rsquo;s first port-forward the Jenkins service to our localhost:</p><p><code>kubectl port-forward svc/jenkins 8080</code>
And now you can open a browser tab and log in by visiting <a href=http://localhost:8080/login>http://localhost:8080/login</a> with the admin user.</p><p><em>For production usage, you may need to add an ingress and serve it with HTTPS.</em></p><hr><h2 id=3-jenkins-gitguardian-kubernetes-connection>3 Jenkins-GitGuardian-Kubernetes Connection<a hidden class=anchor aria-hidden=true href=#3-jenkins-gitguardian-kubernetes-connection>#</a></h2><h3 id=31-creating-a-gitguardian-api-key>3.1 Creating a GitGuardian API Key<a hidden class=anchor aria-hidden=true href=#31-creating-a-gitguardian-api-key>#</a></h3><p>Go to the <a href=https://dashboard.gitguardian.com/api/service-accounts>Service accounts page</a> in the API section of your workspace. Click on <code>Create service account</code>.</p><ol><li>Name your service account according to its use case (for example in this case <code>jenkins-test</code>)</li><li>Set an expiry date for your token (in 1 week, 1 month, 6 months, 1 year, or never). If an expiry date is set, all the Managers of the workspace will receive an email notification 5 days before expiration.</li><li>Choose one or several scopes for your service account.</li><li>Click on Create service account</li></ol><p><img loading=lazy src=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xxdum25so6xuiqrc8m58.png alt="Image description"></p><p>Make sure you copy the service account, it will no longer be visible to you in the future. We&rsquo;re going to put it in a Jenkins credential:</p><p><img loading=lazy src=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/45tscvjdfjtx9co2pdym.png alt="Image description"></p><h3 id=32-making-sure-jenkins-kubernetes-integration-works-fine>3.2 Making Sure Jenkins-Kubernetes Integration Works Fine<a hidden class=anchor aria-hidden=true href=#32-making-sure-jenkins-kubernetes-integration-works-fine>#</a></h3><p>Go to Jenkins -> Manage Jenkins -> Manage Nodes and Clouds -> Configure Clouds, click &ldquo;Kubernetes Cloud Details&mldr;&rdquo;, and test the connection. This should succeed by default since it&rsquo;s the same cluster where our Jenkins lives.</p><p><img loading=lazy src=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/iu2n77qtugzr2y9rvyvi.png alt="Image description"></p><hr><h2 id=4-declarative-pipelines-with-ggshield>4 Declarative Pipelines with <code>ggshield</code><a hidden class=anchor aria-hidden=true href=#4-declarative-pipelines-with-ggshield>#</a></h2><p>After all these preparations, it&rsquo;s time for the important stuff: let&rsquo;s create a Jenkins job and give it a try! Go to Jenkins, click &ldquo;New Item&rdquo;, and create an item of type &ldquo;pipeline&rdquo;.</p><p>And in the &ldquo;pipeline definition&rdquo; part, copy the content below:</p><pre tabindex=0><code>podTemplate(containers: [
    containerTemplate(name: &#39;ggshield&#39;, 
                      image: &#39;gitguardian/ggshield:latest&#39;, 
                      command: &#39;sleep&#39;, 
                      args: &#39;99d&#39;, 
                      runAsUser: &#39;1000&#39;)]) 
  { 
      node(POD_LABEL) {
        stage(&#39;Get a project&#39;) {
            git url:&#39;https://github.com/IronCore864/k8s-vagrant-kubeadm.git&#39;, 
            branch: &#39;main&#39;
            container(&#39;ggshield&#39;) {
                stage(&#39;Scan a project&#39;) {
                    withCredentials(
                    [string(credentialsId: &#39;gitguardian-api-key&#39;, 
                            variable:&#39;GITGUARDIAN_API_KEY&#39;)]) {
                        sh &#39;ggshield scan repo .&#39;
                    }
                }
            }
        }
    }
}
</code></pre><p>For this demo, we&rsquo;ll scan an existing GitHub repository. Some details about this pipeline definition:</p><ul><li>we declare a podTemplate to use in the Kubernetes plugin.</li><li>we override the <code>command</code> with <code>args</code> so that the container won&rsquo;t quit immediately after it&rsquo;s started (because <a href=https://github.com/GitGuardian/ggshield/blob/main/Dockerfile#L38>by default</a>, the <code>gitguardian/ggshield</code> image starts with the command directly).</li><li>we also specify under which user the <code>ggshield</code> container is running with the <code>runAsUser</code> parameter (because by default, <code>ggshield</code> <a href=https://github.com/GitGuardian/ggshield/blob/main/Dockerfile#L30>runs under user 1337</a> and Jenkins JNLP runs with user 1000; so there might be some problems for multi-container pods to access shared files, like the cloned git repo).</li><li>we use <code>withCredentials</code> so that the <code>gitguardian-api-key</code> Jenkins credentials we created earlier will be used as an environment variable for our <code>ggshield</code> CLI tool.</li></ul><p>Let&rsquo;s give it a try:
<img loading=lazy src=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/uheusdrk5mn0ss12063u.png alt="Image description"></p><p>As we can see, it successfully detected a possible leak that looks like an API key; and it is! Because it&rsquo;s a hard-coded token for Kubernetes.</p><hr><h2 id=5-docker-image-scanning-with-jenkins-pipeline>5 Docker Image Scanning with Jenkins Pipeline<a hidden class=anchor aria-hidden=true href=#5-docker-image-scanning-with-jenkins-pipeline>#</a></h2><p>To scan a docker image with <code>ggshield</code>, we can simply run the following command in our CI pipelines:</p><pre tabindex=0><code>ggshield scan docker REPOOWNER/IMAGEREPO
</code></pre><p>To add <code>ggshield</code> docker image scan to your pipelines, configure your Jenkinsfile to add a <code>ggshield</code> stage which scans an image:</p><pre tabindex=0><code>stage(&#39;Get a project&#39;) {
  container(&#39;ggshield&#39;) {
    stage(&#39;Scan an image&#39;) {
      withCredentials([string(credentialsId: &#39;gitguardian-api-key&#39;, variable: &#39;GITGUARDIAN_API_KEY&#39;)]) {
        sh &#39;ggshield scan docker REPOOWNER/IMAGEREPO&#39;
      }
    }
  }
}
</code></pre><p>Similar to the above, do not forget to add your GitGuardian API Key to the <code>gitguardian-api-key</code> credential in your project settings.</p><blockquote><p>üí° Due to our setup (local virtualized K8s with Jenkins running as a pod in the cluster), it&rsquo;s tricky to create a VM and use that VM as a Jenkins worker to join the Jenkins cluster. So we will not demonstrate this part in this tutorial. <strong>In an ideal production-grade setup, we can easily create a Jenkins worker node on a virtual machine for docker images related tasks and pipelines</strong>. Due to the length of this article, we will not include this part as part of the tutorial. If you are interested, see the <a href=https://www.jenkins.io/doc/book/using/using-agents/>official documentation on Jenkins agents</a>.</p></blockquote><hr><h2 id=6-summary>6 Summary<a hidden class=anchor aria-hidden=true href=#6-summary>#</a></h2><p>With containerized Jenkins in Kubernetes, we get to use the CI that we are already familiar with, without the need to migrate to another CI, and we are running it in modern and immutable infrastructure (hence much easier to manage and much less overhead).</p><p>With declarative job descriptions, we get what you write, and we use the pipeline code as the single source of truth of the job.</p><p>With <code>ggshield</code> automated with all the benefits above, we are genuinely achieving DevSecOps.</p><p>If you like this tutorial and want to see more, please like, comment, and subscribe. See you next time!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.guotiexin.com/tags/devsecops/>devsecops</a></li><li><a href=https://www.guotiexin.com/tags/ci/>ci</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://www.guotiexin.com>Tiexin Guo</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>