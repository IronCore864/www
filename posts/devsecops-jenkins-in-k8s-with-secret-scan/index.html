<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan - Tiexin Guo</title><meta name=Description content="This is my cool site"><meta property="og:title" content="How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan"><meta property="og:description" content="This blog post is first published at GitGuardian blog. Disclaimer: this tutorial goes all the way through setting up Jenkins in a Kubernetes minikube cluster, if you&rsquo;re only interested in the Jenkinsfile, jump to the last part! 0 GitGuardian and ggshield ggshield is a CLI application that runs in your local environment or in a CI environment to help you detect more than 350 types of secrets, as well as"><meta property="og:type" content="article"><meta property="og:url" content="https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/"><meta property="og:image" content="https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-12T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-12T00:00:00+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup.png"><meta name=twitter:title content="How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan"><meta name=twitter:description content="This blog post is first published at GitGuardian blog. Disclaimer: this tutorial goes all the way through setting up Jenkins in a Kubernetes minikube cluster, if you&rsquo;re only interested in the Jenkinsfile, jump to the last part! 0 GitGuardian and ggshield ggshield is a CLI application that runs in your local environment or in a CI environment to help you detect more than 350 types of secrets, as well as"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/><link rel=prev href=https://www.guotiexin.com/posts/on-devops-1-what-it-is/><link rel=next href=https://www.guotiexin.com/posts/dmca-takedowns/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.guotiexin.com\/posts\/devsecops-jenkins-in-k8s-with-secret-scan\/"},"image":[{"@type":"ImageObject","url":"https:\/\/www.guotiexin.com\/posts\/devsecops-jenkins-in-k8s-with-secret-scan\/22W16-blog-how-to-setup.png","width":2360,"height":1380}],"genre":"posts","keywords":"devsecops, ci","wordcount":1544,"url":"https:\/\/www.guotiexin.com\/posts\/devsecops-jenkins-in-k8s-with-secret-scan\/","datePublished":"2022-05-12T00:00:00+00:00","dateModified":"2022-05-12T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Tiexin Guo | ÈÉ≠ÈìÅÂøÉ"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Tiexin Guo"><span class=header-title-pre><i class="fa fa-solid fa-terminal"></i></span>Tiexin Guo<span class=header-title-post><i class="fa fa-solid fa-user-secret"></i></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/about>About </a><a class=menu-item href=/portfolio>Portfolio </a><a class=menu-item href=/posts/>Archive </a><a class=menu-item href=https://github.com/ironcore864 rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i> </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Tiexin Guo"><span class=header-title-pre><i class="fa fa-solid fa-terminal"></i></span>Tiexin Guo<span class=header-title-post><i class="fa fa-solid fa-user-secret"></i></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/about title>About</a><a class=menu-item href=/portfolio title>Portfolio</a><a class=menu-item href=/posts/ title>Archive</a><a class=menu-item href=https://github.com/ironcore864 title rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/IronCore864 title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Tiexin Guo | ÈÉ≠ÈìÅÂøÉ</a></span>&nbsp;<span class=post-category>included in <a href=/categories/devsecops/><i class="far fa-folder fa-fw" aria-hidden=true></i>DevSecOps</a>&nbsp;<a href=/categories/ci/><i class="far fa-folder fa-fw" aria-hidden=true></i>CI</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-05-12>2022-05-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1544 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup.png data-srcset="/posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup.png, /posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup.png 1.5x, /posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup.png 2x" data-sizes=auto alt=/posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup.png title=/posts/devsecops-jenkins-in-k8s-with-secret-scan/22W16-blog-how-to-setup.png></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#0-gitguardian-and-ggshield>0 GitGuardian and ggshield</a></li><li><a href=#1-preparing-a-k8s-cluster>1 Preparing a K8s Cluster</a></li><li><a href=#2-running-jenkins-in-k8s>2 Running Jenkins in K8s</a><ul><li><a href=#21-create-a-namespace>2.1 Create a namespace</a></li><li><a href=#22-create-a-persistent-volume>2.2 Create a Persistent Volume</a></li><li><a href=#23-install-jenkins-with-helm>2.3 Install Jenkins with Helm</a></li><li><a href=#24-login-to-jenkins>2.4 Login to Jenkins</a></li></ul></li><li><a href=#3-jenkins-gitguardian-kubernetes-connection>3 Jenkins-GitGuardian-Kubernetes Connection</a><ul><li><a href=#31-creating-a-gitguardian-api-key>3.1 Creating a GitGuardian API Key</a></li><li><a href=#32-making-sure-jenkins-kubernetes-integration-works-fine>3.2 Making Sure Jenkins-Kubernetes Integration Works Fine</a></li></ul></li><li><a href=#4-declarative-pipelines-with-ggshield>4 Declarative Pipelines with <code>ggshield</code></a></li><li><a href=#5-docker-image-scanning-with-jenkins-pipeline>5 Docker Image Scanning with Jenkins Pipeline</a></li><li><a href=#6-summary>6 Summary</a></li></ul></nav></div></div><div class=content id=content><p><em>This blog post is first published at <a href=https://blog.gitguardian.com/how-to-setup-jenkins-with-gitguardian-kubernetes/ target=_blank rel="noopener noreffer">GitGuardian blog</a>.</em></p><p><strong>Disclaimer</strong>: this tutorial goes all the way through <strong>setting up Jenkins in a Kubernetes minikube cluster</strong>, if you&rsquo;re only interested in the <strong>Jenkinsfile</strong>, jump to the last part!</p><hr><h2 id=0-gitguardian-and-ggshield>0 GitGuardian and ggshield</h2><p><a href=https://github.com/GitGuardian/ggshield target=_blank rel="noopener noreffer">ggshield</a> is a CLI application that runs in your local environment or in a CI environment to help you detect more than 350 types of secrets, as well as other potential security vulnerabilities or policy breaks.</p><p>The tool uses GitGuardian&rsquo;s API, more specifically, it will require a service account to set up Jenkins. Service accounts are only available for workspaces under our Business plan and only workspace Managers are allowed to manage service account tokens.</p><blockquote><p>üí° If you&rsquo;d like to learn more about how GitGuardian detects secrets and why it does it well, read about its state-of-the-art <a href=https://docs.gitguardian.com/secrets-detection/quick_start target=_blank rel="noopener noreffer">secrets detection engine</a>.</p></blockquote><p>In this tutorial, we will show how to run one of the most famous CI tools that is <strong>Jenkins</strong>, in a Kubernetes cluster, and how to integrate ggshield with it as a neat declarative pipeline step (with a <strong>bonus</strong>: how to add Docker image scanning).</p><p><strong>Note</strong>: if using GitHub Actions, it&rsquo;s actually quite easy to integrate ggshield as part of your workflow using GitGuardian&rsquo;s official gg-shield-action. Actually, I&rsquo;ve already done a tutorial covering exactly that!</p><p>After reading this tutorial, you will be able to:</p><ul><li>install Jenkins in a Kubernetes cluster;</li><li>integrate Jenkins/Kubernetes/GitGuardian together;</li><li>scan your repo for secrets leak with <code>ggshield</code> in a Jenkins pipeline running in a Kubernetes pod;</li><li>scan a Docker image in your Jenkins pipeline.
Without further ado, let&rsquo;s get started.</li></ul><hr><h2 id=1-preparing-a-k8s-cluster>1 Preparing a K8s Cluster</h2><p>If you don&rsquo;t already have a K8s cluster yet, follow this section; otherwise, jump to the next.</p><p>We will use <code>minikube</code>, which is a tool that creates a single-node Kubernetes cluster on your computer. For Mac users, you can easily run:</p><pre tabindex=0><code>brew install minikube
</code></pre><p>to install <code>minikube</code>. For other operating systems users, refer to the <a href=https://minikube.sigs.k8s.io/docs/start/ target=_blank rel="noopener noreffer">official doc</a>.</p><p>Once <code>minikube</code> is installed, you can create a <code>minikube</code> cluster by entering the following command:</p><pre tabindex=0><code>minikube start
</code></pre><p>Once the cluster has been created, you can verify its status by entering:</p><pre tabindex=0><code>minikube status
</code></pre><hr><h2 id=2-running-jenkins-in-k8s>2 Running Jenkins in K8s</h2><h3 id=21-create-a-namespace>2.1 Create a namespace</h3><p>A distinct namespace provides an additional layer of isolation and more control over the continuous integration environment.</p><p>Create a namespace for the Jenkins deployment by typing the following command on your terminal:</p><pre tabindex=0><code>kubectl create namespace jenkins
</code></pre><h3 id=22-create-a-persistent-volume>2.2 Create a Persistent Volume</h3><p>We want to create a persistent volume for our Jenkins controller pod (we choose the /data directory). This will prevent us from losing our whole Jenkins controller configuration and jobs when we reboot our <code>minikube</code>.</p><p>In a multi-node Kubernetes cluster, you‚Äôll need some solution like NFS to make the mount directory available in the whole cluster. But because we use <code>minikube</code>, which is a one-node cluster, we don‚Äôt have to bother about it. We choose to use the <code>/data</code> directory. This directory will contain our Jenkins controller configuration.</p><p>We will create a volume which is called <code>jenkins-pv</code>. Create a file <code>jenkins-volume.yaml</code> based on the content here, and apply it:</p><pre tabindex=0><code>kubectl apply -f jenkins-volume.yaml
</code></pre><p><em>Note 1: in the above spec, hostPath uses the <code>/data/jenkins-volume/</code> of your node to emulate network-attached storage. <strong>This approach is only suited for development and testing purposes</strong>. For production, you should provide a network resource like a Google Compute Engine persistent disk or an Amazon Elastic Block Store volume.</em></p><p><em>Note 2: <code>minikube</code> configured for hostPath sets the permissions on <code>/data</code> to the root account only. Once the volume is created, you will need to manually change the permissions to allow the Jenkins account to write its data by running:</em></p><pre tabindex=0><code>minikube ssh
sudo chown -R 1000:1000 /data/jenkins-volume
</code></pre><p>At this exact moment, if you have been following the tutorial exactly, the <code>/data</code> folder has been created, but not the <code>/data/jenkins-volume</code>. You might want to return to this step again after <code>helm install</code> in the next section.</p><h3 id=23-install-jenkins-with-helm>2.3 Install Jenkins with Helm</h3><blockquote><p>From there you need Helm CLI, if you don&rsquo;t already have it follow the instructions from the <a href=https://helm.sh/docs/intro/install/ target=_blank rel="noopener noreffer">Installing Helm</a> page.</p></blockquote><p>First, let&rsquo;s create the required service accounts:</p><p>Create a file <code>jenkins-sa.yaml</code> based on the <a href=https://github.com/IronCore864/jenkins-ggshield-tutorial/blob/main/values.yaml target=_blank rel="noopener noreffer">content here</a>, and apply it:</p><pre tabindex=0><code>kubectl apply -f jenkins-sa.yaml
</code></pre><p>Next, we prepare a <code>values.yaml</code> file based on the <a href=https://github.com/IronCore864/jenkins-ggshield-tutorial/blob/main/values.yaml target=_blank rel="noopener noreffer">content here</a>, and install Jenkins with helm using the values file:</p><pre tabindex=0><code>helm repo add jenkinsci https://charts.jenkins.io
helm repo update
helm upgrade --install jenkins -n jenkins -f values.yaml jenkinsci/jenkins
</code></pre><h3 id=24-login-to-jenkins>2.4 Login to Jenkins</h3><p>After the installation, to get the default password for your Jenkins admin user, run:</p><pre tabindex=0><code>jsonpath=&#34;{.data.jenkins-admin-password}&#34;
secret=$(kubectl get secret -n jenkins jenkins -o jsonpath=$jsonpath)
echo $(echo $secret | base64 --decode)
</code></pre><p>The username is admin.</p><p>To login, let&rsquo;s first port-forward the Jenkins service to our localhost:</p><p><code>kubectl port-forward svc/jenkins 8080</code>
And now you can open a browser tab and log in by visiting <a href=http://localhost:8080/login target=_blank rel="noopener noreffer">http://localhost:8080/login</a> with the admin user.</p><p><em>For production usage, you may need to add an ingress and serve it with HTTPS.</em></p><hr><h2 id=3-jenkins-gitguardian-kubernetes-connection>3 Jenkins-GitGuardian-Kubernetes Connection</h2><h3 id=31-creating-a-gitguardian-api-key>3.1 Creating a GitGuardian API Key</h3><p>Go to the <a href=https://dashboard.gitguardian.com/api/service-accounts target=_blank rel="noopener noreffer">Service accounts page</a> in the API section of your workspace. Click on <code>Create service account</code>.</p><ol><li>Name your service account according to its use case (for example in this case <code>jenkins-test</code>)</li><li>Set an expiry date for your token (in 1 week, 1 month, 6 months, 1 year, or never). If an expiry date is set, all the Managers of the workspace will receive an email notification 5 days before expiration.</li><li>Choose one or several scopes for your service account.</li><li>Click on Create service account</li></ol><p><img class=lazyload src=/svg/loading.min.svg data-src=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xxdum25so6xuiqrc8m58.png data-srcset="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xxdum25so6xuiqrc8m58.png, https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xxdum25so6xuiqrc8m58.png 1.5x, https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xxdum25so6xuiqrc8m58.png 2x" data-sizes=auto alt=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xxdum25so6xuiqrc8m58.png title="Image description"></p><p>Make sure you copy the service account, it will no longer be visible to you in the future. We&rsquo;re going to put it in a Jenkins credential:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/45tscvjdfjtx9co2pdym.png data-srcset="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/45tscvjdfjtx9co2pdym.png, https://dev-to-uploads.s3.amazonaws.com/uploads/articles/45tscvjdfjtx9co2pdym.png 1.5x, https://dev-to-uploads.s3.amazonaws.com/uploads/articles/45tscvjdfjtx9co2pdym.png 2x" data-sizes=auto alt=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/45tscvjdfjtx9co2pdym.png title="Image description"></p><h3 id=32-making-sure-jenkins-kubernetes-integration-works-fine>3.2 Making Sure Jenkins-Kubernetes Integration Works Fine</h3><p>Go to Jenkins -> Manage Jenkins -> Manage Nodes and Clouds -> Configure Clouds, click &ldquo;Kubernetes Cloud Details&mldr;&rdquo;, and test the connection. This should succeed by default since it&rsquo;s the same cluster where our Jenkins lives.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/iu2n77qtugzr2y9rvyvi.png data-srcset="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/iu2n77qtugzr2y9rvyvi.png, https://dev-to-uploads.s3.amazonaws.com/uploads/articles/iu2n77qtugzr2y9rvyvi.png 1.5x, https://dev-to-uploads.s3.amazonaws.com/uploads/articles/iu2n77qtugzr2y9rvyvi.png 2x" data-sizes=auto alt=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/iu2n77qtugzr2y9rvyvi.png title="Image description"></p><hr><h2 id=4-declarative-pipelines-with-ggshield>4 Declarative Pipelines with <code>ggshield</code></h2><p>After all these preparations, it&rsquo;s time for the important stuff: let&rsquo;s create a Jenkins job and give it a try! Go to Jenkins, click &ldquo;New Item&rdquo;, and create an item of type &ldquo;pipeline&rdquo;.</p><p>And in the &ldquo;pipeline definition&rdquo; part, copy the content below:</p><pre tabindex=0><code>podTemplate(containers: [
    containerTemplate(name: &#39;ggshield&#39;, 
                      image: &#39;gitguardian/ggshield:latest&#39;, 
                      command: &#39;sleep&#39;, 
                      args: &#39;99d&#39;, 
                      runAsUser: &#39;1000&#39;)]) 
  { 
      node(POD_LABEL) {
        stage(&#39;Get a project&#39;) {
            git url:&#39;https://github.com/IronCore864/k8s-vagrant-kubeadm.git&#39;, 
            branch: &#39;main&#39;
            container(&#39;ggshield&#39;) {
                stage(&#39;Scan a project&#39;) {
                    withCredentials(
                    [string(credentialsId: &#39;gitguardian-api-key&#39;, 
                            variable:&#39;GITGUARDIAN_API_KEY&#39;)]) {
                        sh &#39;ggshield scan repo .&#39;
                    }
                }
            }
        }
    }
}
</code></pre><p>For this demo, we&rsquo;ll scan an existing GitHub repository. Some details about this pipeline definition:</p><ul><li>we declare a podTemplate to use in the Kubernetes plugin.</li><li>we override the <code>command</code> with <code>args</code> so that the container won&rsquo;t quit immediately after it&rsquo;s started (because <a href=https://github.com/GitGuardian/ggshield/blob/main/Dockerfile#L38 target=_blank rel="noopener noreffer">by default</a>, the <code>gitguardian/ggshield</code> image starts with the command directly).</li><li>we also specify under which user the <code>ggshield</code> container is running with the <code>runAsUser</code> parameter (because by default, <code>ggshield</code> <a href=https://github.com/GitGuardian/ggshield/blob/main/Dockerfile#L30 target=_blank rel="noopener noreffer">runs under user 1337</a> and Jenkins JNLP runs with user 1000; so there might be some problems for multi-container pods to access shared files, like the cloned git repo).</li><li>we use <code>withCredentials</code> so that the <code>gitguardian-api-key</code> Jenkins credentials we created earlier will be used as an environment variable for our <code>ggshield</code> CLI tool.</li></ul><p>Let&rsquo;s give it a try:
<img class=lazyload src=/svg/loading.min.svg data-src=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/uheusdrk5mn0ss12063u.png data-srcset="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/uheusdrk5mn0ss12063u.png, https://dev-to-uploads.s3.amazonaws.com/uploads/articles/uheusdrk5mn0ss12063u.png 1.5x, https://dev-to-uploads.s3.amazonaws.com/uploads/articles/uheusdrk5mn0ss12063u.png 2x" data-sizes=auto alt=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/uheusdrk5mn0ss12063u.png title="Image description"></p><p>As we can see, it successfully detected a possible leak that looks like an API key; and it is! Because it&rsquo;s a hard-coded token for Kubernetes.</p><hr><h2 id=5-docker-image-scanning-with-jenkins-pipeline>5 Docker Image Scanning with Jenkins Pipeline</h2><p>To scan a docker image with <code>ggshield</code>, we can simply run the following command in our CI pipelines:</p><pre tabindex=0><code>ggshield scan docker REPOOWNER/IMAGEREPO
</code></pre><p>To add <code>ggshield</code> docker image scan to your pipelines, configure your Jenkinsfile to add a <code>ggshield</code> stage which scans an image:</p><pre tabindex=0><code>stage(&#39;Get a project&#39;) {
  container(&#39;ggshield&#39;) {
    stage(&#39;Scan an image&#39;) {
      withCredentials([string(credentialsId: &#39;gitguardian-api-key&#39;, variable: &#39;GITGUARDIAN_API_KEY&#39;)]) {
        sh &#39;ggshield scan docker REPOOWNER/IMAGEREPO&#39;
      }
    }
  }
}
</code></pre><p>Similar to the above, do not forget to add your GitGuardian API Key to the <code>gitguardian-api-key</code> credential in your project settings.</p><blockquote><p>üí° Due to our setup (local virtualized K8s with Jenkins running as a pod in the cluster), it&rsquo;s tricky to create a VM and use that VM as a Jenkins worker to join the Jenkins cluster. So we will not demonstrate this part in this tutorial. <strong>In an ideal production-grade setup, we can easily create a Jenkins worker node on a virtual machine for docker images related tasks and pipelines</strong>. Due to the length of this article, we will not include this part as part of the tutorial. If you are interested, see the <a href=https://www.jenkins.io/doc/book/using/using-agents/ target=_blank rel="noopener noreffer">official documentation on Jenkins agents</a>.</p></blockquote><hr><h2 id=6-summary>6 Summary</h2><p>With containerized Jenkins in Kubernetes, we get to use the CI that we are already familiar with, without the need to migrate to another CI, and we are running it in modern and immutable infrastructure (hence much easier to manage and much less overhead).</p><p>With declarative job descriptions, we get what you write, and we use the pipeline code as the single source of truth of the job.</p><p>With <code>ggshield</code> automated with all the benefits above, we are genuinely achieving DevSecOps.</p><p>If you like this tutorial and want to see more, please like, comment, and subscribe. See you next time!</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-05-12</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/ data-title="How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan" data-hashtags=devsecops,ci><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/ data-hashtag=devsecops><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/ data-title="How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/ data-title="How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on ÂæÆÂçö" data-sharer=weibo data-url=https://www.guotiexin.com/posts/devsecops-jenkins-in-k8s-with-secret-scan/ data-title="How To Setup Your Jenkins Pipeline in K8s with Git Secrets Leak Scan and Docker Image Scan"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/devsecops/>devsecops</a>,&nbsp;<a href=/tags/ci/>ci</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/on-devops-1-what-it-is/ class=prev rel=prev title="On DevOps: 1. What It Is"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>On DevOps: 1. What It Is</a>
<a href=/posts/dmca-takedowns/ class=next rel=next title="A Brief History of the DMCA">A Brief History of the DMCA<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Copyright: Tiexin Guo | CC BY-NC 4.0</div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>