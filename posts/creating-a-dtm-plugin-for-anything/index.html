<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Creating a DevStream (dtm) Plugin for Anything - Tiexin Guo</title><meta name=Description content="This is my cool site"><meta property="og:title" content="Creating a DevStream (dtm) Plugin for Anything"><meta property="og:description" content="Yes, the title of this post isn&rsquo;t bluffing: you can actually create a plugin for just about anything that takes your fancy. In my previous article, I walked you guys through DevStream&rsquo;s codebase. If you haven&rsquo;t read it yet, here&rsquo;s a quick link for you: Hello, world! In this blog, we will walk you through the steps of creating a DevStream plugin from scratch with an example. What is DevStream"><meta property="og:type" content="article"><meta property="og:url" content="https://www.guotiexin.com/posts/creating-a-dtm-plugin-for-anything/"><meta property="og:image" content="https://www.guotiexin.com/posts/creating-a-dtm-plugin-for-anything/cat.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-29T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-29T00:00:00+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.guotiexin.com/posts/creating-a-dtm-plugin-for-anything/cat.jpg"><meta name=twitter:title content="Creating a DevStream (dtm) Plugin for Anything"><meta name=twitter:description content="Yes, the title of this post isn&rsquo;t bluffing: you can actually create a plugin for just about anything that takes your fancy. In my previous article, I walked you guys through DevStream&rsquo;s codebase. If you haven&rsquo;t read it yet, here&rsquo;s a quick link for you: Hello, world! In this blog, we will walk you through the steps of creating a DevStream plugin from scratch with an example. What is DevStream"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.guotiexin.com/posts/creating-a-dtm-plugin-for-anything/><link rel=prev href=https://www.guotiexin.com/posts/hello-world/><link rel=next href=https://www.guotiexin.com/posts/dagger-in-depth/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Creating a DevStream (dtm) Plugin for Anything","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.guotiexin.com\/posts\/creating-a-dtm-plugin-for-anything\/"},"image":[{"@type":"ImageObject","url":"https:\/\/www.guotiexin.com\/posts\/creating-a-dtm-plugin-for-anything\/cat.jpg","width":1200,"height":800}],"genre":"posts","keywords":"devstream","wordcount":2345,"url":"https:\/\/www.guotiexin.com\/posts\/creating-a-dtm-plugin-for-anything\/","datePublished":"2022-03-29T00:00:00+00:00","dateModified":"2022-03-29T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Tiexin Guo | 郭铁心"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Tiexin Guo"><span class=header-title-pre><i class="fa fa-solid fa-terminal"></i></span>Tiexin Guo<span class=header-title-post><i class="fa fa-solid fa-user-secret"></i></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/about>About </a><a class=menu-item href=/portfolio>Portfolio </a><a class=menu-item href=/posts/>Archive </a><a class=menu-item href=https://github.com/ironcore864 rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i> </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Tiexin Guo"><span class=header-title-pre><i class="fa fa-solid fa-terminal"></i></span>Tiexin Guo<span class=header-title-post><i class="fa fa-solid fa-user-secret"></i></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/about title>About</a><a class=menu-item href=/portfolio title>Portfolio</a><a class=menu-item href=/posts/ title>Archive</a><a class=menu-item href=https://github.com/ironcore864 title rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Creating a DevStream (dtm) Plugin for Anything</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/IronCore864 title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Tiexin Guo | 郭铁心</a></span>&nbsp;<span class=post-category>included in <a href=/categories/devstream/><i class="far fa-folder fa-fw" aria-hidden=true></i>DevStream</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-03-29>2022-03-29</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2345 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;5 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/posts/creating-a-dtm-plugin-for-anything/cat.jpg data-srcset="/posts/creating-a-dtm-plugin-for-anything/cat.jpg, /posts/creating-a-dtm-plugin-for-anything/cat.jpg 1.5x, /posts/creating-a-dtm-plugin-for-anything/cat.jpg 2x" data-sizes=auto alt=/posts/creating-a-dtm-plugin-for-anything/cat.jpg title=/posts/creating-a-dtm-plugin-for-anything/cat.jpg></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#what-is-devstream>What is DevStream</a></li><li><a href=#existing-plugins>Existing Plugins</a></li><li><a href=#why-would-i-want-to-create-a-devstream-plugin>Why Would I Want to Create a DevStream Plugin</a></li><li><a href=#design-a-local-file-plugin>Design: A &ldquo;Local File&rdquo; Plugin</a></li><li><a href=#scaffolding-automagically>Scaffolding Automagically</a><ul><li><a href=#cmd>cmd/</a></li><li><a href=#docs>docs/</a></li><li><a href=#internalpkg>internal/pkg/</a></li></ul></li><li><a href=#core-concepts>Core Concepts</a><ul><li><a href=#configstateresource>Config/State/Resource</a></li><li><a href=#interfaces>Interfaces</a></li></ul></li><li><a href=#coding>Coding</a><ul><li><a href=#input-optionsvalidation>Input Options/Validation</a></li><li><a href=#create>Create()</a></li><li><a href=#read>Read()</a></li><li><a href=#update>Update()</a></li><li><a href=#delete>Delete()</a></li></ul></li><li><a href=#build>Build</a></li><li><a href=#test>Test</a></li><li><a href=#summary>Summary</a></li></ul></nav></div></div><div class=content id=content><p>Yes, the title of this post isn&rsquo;t bluffing: you can actually create a plugin for just about anything that takes your fancy.</p><blockquote><p>In my previous article, I walked you guys through DevStream&rsquo;s codebase.</p><p>If you haven&rsquo;t read it yet, here&rsquo;s a quick link for you:</p><p><a href=../hello-world rel>Hello, world!</a></p></blockquote><p>In this blog, we will walk you through the steps of creating a DevStream plugin from scratch with an example.</p><hr><h2 id=what-is-devstream>What is DevStream</h2><p>DevStream is an amazing tool that lets you install, update, manage, and integrate your DevOps tools quickly and flexibly.</p><p>Not to brag, but with DevStream, you can have your own DevOps toolchain that is specifically tailored to your need up and running in 5 minutes.</p><p>Don&rsquo;t believe it? Check out our <a href=https://www.devstream.io/docs/index target=_blank rel="noopener noreffer">docs</a> and follow the quickstart guide!</p><h2 id=existing-plugins>Existing Plugins</h2><p>At the moment of publishing this article, we already support the following tools:</p><ul><li>Trello (including integration with GitHub)</li><li>Jira (integration with GitHub)</li><li>GitHub Repository bootstrapping (for Go)</li><li>GitHub Actions (for Go, Python, and Nodejs)</li><li>GitLab CI (for Go)</li><li>Jenkins (installation)</li><li>ArgoCD</li><li>ArgoCD Application (the deployment of your apps)</li><li>Prometheus + Grafana</li><li>DevLake</li><li>OpenLDAP</li></ul><p>We aim to have 50 plugins at the end of 2022!</p><p>Check out our <a href=https://github.com/devstream-io/devstream target=_blank rel="noopener noreffer">README</a> for the latest status.</p><h2 id=why-would-i-want-to-create-a-devstream-plugin>Why Would I Want to Create a DevStream Plugin</h2><p>Wait. YOU ALREADY HAVE TONS OF PLUGINS! Why on earth would I want to create yet another one?</p><p>I agree with you.</p><p>Can I get a show of hands, who here has made a DevStream plugin before?</p><p>Very few, if any, I guess.</p><p>However (I know it&rsquo;s just a fancy &ldquo;but&rdquo;), there are, in fact, things that you want to build a plugin for:</p><ul><li>Maybe you are building a nice and shiny DevOps tool, and you want to be able to set it up quickly without any hassle. You would have to write some automation scripts for it anyway, right? DevStream got you covered.</li><li>Maybe you even need to integrate your tool with other tools to get the most out of it and you really don&rsquo;t want to reinvent a lot of wheels just to manage those boring integrations. Again, DevStream got you covered.</li><li>Maybe you have both internal tools and open-source tools whose installation and integration need to be automated. The open-source tools are fine, but how to manage those internal ones and integrate them? DevStream got you covered.</li></ul><p>Or, maybe you just want to learn Go&rsquo;s plugin, become a contributor, join our community and earn your certification (maybe a small present, too, who knows.) No problem.</p><p>No matter what your intention is and what thing you want to achieve, DevStream got you covered.</p><p>So hang tight, let&rsquo;s get started.</p><h2 id=design-a-local-file-plugin>Design: A &ldquo;Local File&rdquo; Plugin</h2><p>In this example, let&rsquo;s build something dum but simple, just to show you the process of creating a plugin.</p><p>We are creating a &ldquo;local file&rdquo; plugin. You specify the name and the content, and the plugin will create a local file for you. Let&rsquo;s decide how we are going to use this plugin:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tools</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>plugin</span><span class=p>:</span><span class=w> </span><span class=l>localfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>options</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>filename</span><span class=p>:</span><span class=w> </span><span class=l>foo.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>content</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;hello, world&#34;</span><span class=w>
</span></span></span></code></pre></div><p>Basically:</p><ul><li>the name of the plugin: <code>localfile</code></li><li>options of the plugin:<ul><li>filename</li><li>content</li></ul></li></ul><p>The plugin will create a file with desired content according to this piece of config.</p><h2 id=scaffolding-automagically>Scaffolding Automagically</h2><p>First, let&rsquo;s clone the DevStream repo and generate some scaffolding code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git clone git@github.com:devstream-io/devstream.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> stream
</span></span><span class=line><span class=cl><span class=c1># builds dtm locally to make sure it&#39;s using the same dependencies as your new plugin</span>
</span></span><span class=line><span class=cl>make build-core
</span></span><span class=line><span class=cl>./dtm develop create-plugin --name<span class=o>=</span>localfile
</span></span></code></pre></div><p>There will be some useful output to guide you through the whole process.</p><p>Now, if we do a <code>git status</code>, we can see some new stuff are already created automagically:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ git status
</span></span><span class=line><span class=cl>On branch main
</span></span><span class=line><span class=cl>Your branch is up to date with <span class=s1>&#39;origin/main&#39;</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Untracked files:
</span></span><span class=line><span class=cl>  <span class=o>(</span>use <span class=s2>&#34;git add &lt;file&gt;...&#34;</span> to include in what will be committed<span class=o>)</span>
</span></span><span class=line><span class=cl>    cmd/plugin/localfile/
</span></span><span class=line><span class=cl>    docs/plugins/localfile.md
</span></span><span class=line><span class=cl>    internal/pkg/plugin/localfile/
</span></span></code></pre></div><p>Let&rsquo;s have a quick recap of the directory structure:</p><h3 id=cmd>cmd/</h3><p><code>cmd/plugin/localfile/main.go</code> is the main entrance of your plugin. But here you don&rsquo;t need to do anything; nothing.</p><p><code>dtm</code> has already generated the code for you, including the interfaces that you must implement.</p><h3 id=docs>docs/</h3><p><code>docs/plugins/localfile.md</code> is the automatically generated documentation.</p><p>Yep, I know <code>dtm</code> is automagic, but it can&rsquo;t read your mind. I&rsquo;m afraid that you will have to write your own doc.</p><p>But hey, at least here you get a reminder that you need to create a doc :)</p><h3 id=internalpkg>internal/pkg/</h3><p><code>internal/pkg/plugin/localfile</code> has your plugin&rsquo;s main logic.</p><p>Here, we need to:</p><ul><li>define your input parameters (options);</li><li>implement the validation of the input parameters;</li><li>implement four mandatory interfaces.</li></ul><h2 id=core-concepts>Core Concepts</h2><h3 id=configstateresource>Config/State/Resource</h3><p>Before explaining interfaces and implementing them, let&rsquo;s have a look at how DevStream actually works:</p><ul><li><em>Config</em> is a list of tools, each of which has a name, plugin, options, etc.</li><li><em>State</em> is a map containing each tool&rsquo;s name, plugin, options, etc. It&rsquo;s used to store the result of <code>dtm</code>&rsquo;s last action.</li><li><em>Resource</em> is the tool that the plugin created. The <code>Read</code> interface returns a description of that resource, which should be the same as the <em>State</em> if nothing has been changed after <code>dtm</code>&rsquo;s last action.</li></ul><p>DevStream decides what to do based on your <em>Config</em>, the <em>State</em>, and the <em>Resource</em>&rsquo;s status. See the flowchart below:</p><p><figure><a class=lightgallery href=/posts/creating-a-dtm-plugin-for-anything/config_state_resource.png title="dtm config state resource" data-thumbnail=/posts/creating-a-dtm-plugin-for-anything/config_state_resource.png data-sub-html="<h2>DevStream Config, State and Resource</h2><p>dtm config state resource</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/creating-a-dtm-plugin-for-anything/config_state_resource.png data-srcset="/posts/creating-a-dtm-plugin-for-anything/config_state_resource.png, /posts/creating-a-dtm-plugin-for-anything/config_state_resource.png 1.5x, /posts/creating-a-dtm-plugin-for-anything/config_state_resource.png 2x" data-sizes=auto alt=/posts/creating-a-dtm-plugin-for-anything/config_state_resource.png width=584 height=1052></a><figcaption class=image-caption>DevStream Config, State and Resource</figcaption></figure></p><h3 id=interfaces>Interfaces</h3><p>A quick recap: each DevStream plugin must satisfy the following four interfaces:</p><ul><li><code>Create</code></li><li><code>Read</code></li><li><code>Update</code></li><li><code>Delete</code></li></ul><p>Return values:</p><ul><li><code>Create</code> and <code>Update</code> return two values <code>(map[string]interface{}, error)</code>. The first return value is considered as the <em>State</em>, which will be stored in DevStream&rsquo;s state file.</li><li><code>Read</code>&rsquo;s first return value is a description of the <em>Resource</em>, which should be the same as the <em>State</em> if nothing has changed.</li><li><code>Delete</code> returns <code>(true, nil)</code> if there is no error; otherwise it returns <code>(false, error)</code>.</li></ul><h2 id=coding>Coding</h2><h3 id=input-optionsvalidation>Input Options/Validation</h3><p>Now let&rsquo;s open <code>internal/pkg/plugin/localfile/options.go</code> and add options according to our design in the previous section.</p><p>The <code>internal/pkg/plugin/localfile/options.go</code> should look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>localfile</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Options is the struct for configurations of the localfile plugin.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Options</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Filename</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Content</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Let&rsquo;s also implement the validation function of the input options.</p><p>Open <code>internal/pkg/plugin/localfile/validate.go</code> and change the logic to verify the options. It should look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>localfile</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// validate validates the options provided by the core.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>validate</span><span class=p>(</span><span class=nx>options</span> <span class=o>*</span><span class=nx>Options</span><span class=p>)</span> <span class=p>[]</span><span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>error</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>options</span><span class=p>.</span><span class=nx>Filename</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;filename does not exist&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>res</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=create>Create()</h3><p>We want to create the file based on the input options. So, let&rsquo;s do just that in the file <code>internal/pkg/plugin/localfile/create.go</code>.</p><p>OK, talk is cheap, show me the code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>localfile</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/mitchellh/mapstructure&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/devstream-io/devstream/pkg/util/log&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Create</span><span class=p>(</span><span class=nx>options</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>opts</span> <span class=nx>Options</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>mapstructure</span><span class=p>.</span><span class=nf>Decode</span><span class=p>(</span><span class=nx>options</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>opts</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>errs</span> <span class=o>:=</span> <span class=nf>validate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>opts</span><span class=p>);</span> <span class=nb>len</span><span class=p>(</span><span class=nx>errs</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>errs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Options error: %s.&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;opts are illegal&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nf>writefile</span><span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>Filename</span><span class=p>,</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>Content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>status</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;filename&#34;</span><span class=p>:</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>Filename</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;content&#34;</span><span class=p>:</span>  <span class=nx>opts</span><span class=p>.</span><span class=nx>Content</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>status</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>If you compare the code above to the code generated by <code>dtm develop</code>, you will see that we basically did nothing here. We only filled some blanks which are marked by <code>dtm</code>&rsquo;s comment. The same is true for all the other interfaces.</p><p><em>A small tip: here, we can put the function <code>writefile</code> in <code>internal/pkg/plugin/localfile/localfile.go</code>, so that the code is better organized.</em></p><p>The <code>localfile.go</code> will look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>localfile</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>writefile</span><span class=p>(</span><span class=nx>filename</span><span class=p>,</span> <span class=nx>content</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=read>Read()</h3><p>Let&rsquo;s also implement the <code>Read</code> interface.</p><p>The logic is simple: we want to try to see if the file exists or not, and if yes, what&rsquo;s the filename and content.</p><p><code>internal/pkg/plugin/localfile/read.go</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>localfile</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/mitchellh/mapstructure&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/devstream-io/devstream/pkg/util/log&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Read</span><span class=p>(</span><span class=nx>options</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>opts</span> <span class=nx>Options</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>mapstructure</span><span class=p>.</span><span class=nf>Decode</span><span class=p>(</span><span class=nx>options</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>opts</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>errs</span> <span class=o>:=</span> <span class=nf>validate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>opts</span><span class=p>);</span> <span class=nb>len</span><span class=p>(</span><span class=nx>errs</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>errs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Options error: %s.&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;opts are illegal&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>content</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>Filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=s>&#34;no such file or directory&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>status</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;filename&#34;</span><span class=p>:</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>Filename</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;content&#34;</span><span class=p>:</span>  <span class=nb>string</span><span class=p>(</span><span class=nx>content</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>status</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>On the return value:</p><ul><li>If the file doesn&rsquo;t exist, return nil, no error, because it means the resource hasn&rsquo;t been created yet (or deleted by somebody)</li><li>If the file exists, return the &ldquo;status&rdquo; of it and no error.</li><li>Otherwise, return nil and the error.</li></ul><h3 id=update>Update()</h3><p><code>Update</code> will be triggered if <code>Read</code> returns a different result than what&rsquo;s recorded in the <em>State</em>.</p><p>For the implementation, since we are updating a file, it&rsquo;s the same as <code>Create</code>, so we can actually reuse it here without duplicated code:</p><p><code>internal/pkg/plugin/localfile/update.go</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>localfile</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Update</span><span class=p>(</span><span class=nx>options</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>Create</span><span class=p>(</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=delete>Delete()</h3><p>Last but not least, let&rsquo;s implement the <code>Delete</code> interface.</p><p><code>internal/pkg/plugin/localfile/delete.go</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>localfile</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/mitchellh/mapstructure&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/devstream-io/devstream/pkg/util/log&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Delete</span><span class=p>(</span><span class=nx>options</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>opts</span> <span class=nx>Options</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>mapstructure</span><span class=p>.</span><span class=nf>Decode</span><span class=p>(</span><span class=nx>options</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>opts</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>errs</span> <span class=o>:=</span> <span class=nf>validate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>opts</span><span class=p>);</span> <span class=nb>len</span><span class=p>(</span><span class=nx>errs</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>errs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Options error: %s.&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;opts are illegal&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Remove</span><span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>Filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Just delete the file; nothing to look at here.</p><h2 id=build>Build</h2><p>Now that we finished coding, let&rsquo;s build our new plugin. Our Makefile now supports building a specific plugin only:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>make build-plugin.localfile
</span></span></code></pre></div><h2 id=test>Test</h2><p>First, let&rsquo;s create a config file <code>config-localfile-test.yaml</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tools</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>plugin</span><span class=p>:</span><span class=w> </span><span class=l>localfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>options</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>filename</span><span class=p>:</span><span class=w> </span><span class=l>foo.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>content</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;hello, world&#34;</span><span class=w>
</span></span></span></code></pre></div><p>Now, let&rsquo;s <code>apply</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ./dtm -y apply -f config-localfile-test.yaml
</span></span><span class=line><span class=cl>2022-03-29 11:25:17 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Apply started.
</span></span><span class=line><span class=cl>2022-03-29 11:25:17 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Using dir &lt;.devstream&gt; to store plugins.
</span></span><span class=line><span class=cl>2022-03-29 11:25:17 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Tool my-file <span class=o>(</span>localfile<span class=o>)</span> found in config but doesn<span class=err>&#39;</span>t exist in the state, will be created.
</span></span><span class=line><span class=cl>2022-03-29 11:25:17 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Start executing the plan.
</span></span><span class=line><span class=cl>2022-03-29 11:25:17 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Changes count: 1.
</span></span><span class=line><span class=cl>2022-03-29 11:25:17 ℹ <span class=o>[</span>INFO<span class=o>]</span>  -------------------- <span class=o>[</span>  Processing progress: 1/1.  <span class=o>]</span> --------------------
</span></span><span class=line><span class=cl>2022-03-29 11:25:17 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Processing: my-file <span class=o>(</span>localfile<span class=o>)</span> -&gt; Create ...
</span></span><span class=line><span class=cl>2022-03-29 11:25:17 ✔ <span class=o>[</span>SUCCESS<span class=o>]</span>  Plugin my-file<span class=o>(</span>localfile<span class=o>)</span> Create <span class=k>done</span>.
</span></span><span class=line><span class=cl>2022-03-29 11:25:17 ℹ <span class=o>[</span>INFO<span class=o>]</span>  -------------------- <span class=o>[</span>  Processing <span class=k>done</span>.  <span class=o>]</span> --------------------
</span></span><span class=line><span class=cl>2022-03-29 11:25:17 ✔ <span class=o>[</span>SUCCESS<span class=o>]</span>  All plugins applied successfully.
</span></span><span class=line><span class=cl>2022-03-29 11:25:17 ✔ <span class=o>[</span>SUCCESS<span class=o>]</span>  Apply finished.
</span></span></code></pre></div><p>As we can see, the plugin has created our file successfully. To verify, you can open the &ldquo;foo.txt&rdquo; file to have a look.</p><p>If we <code>apply</code> again, nothing should happen, since the file is already created with the desired content:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ./dtm -y apply -f config-localfile-test.yaml
</span></span><span class=line><span class=cl>2022-03-29 11:30:43 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Apply started.
</span></span><span class=line><span class=cl>2022-03-29 11:30:43 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Using dir &lt;.devstream&gt; to store plugins.
</span></span><span class=line><span class=cl>2022-03-29 11:30:45 ℹ <span class=o>[</span>INFO<span class=o>]</span>  No changes <span class=k>done</span> since last apply. There is nothing to <span class=k>do</span>.
</span></span><span class=line><span class=cl>2022-03-29 11:30:45 ✔ <span class=o>[</span>SUCCESS<span class=o>]</span>  Apply finished.
</span></span></code></pre></div><p>But, what if somebody changed the content of &ldquo;foo.txt&rdquo;? Let&rsquo;s experiment:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;changed&#34;</span> &gt; foo.txt
</span></span><span class=line><span class=cl>$ ./dtm -y apply -f config-localfile-test.yaml
</span></span><span class=line><span class=cl>2022-03-29 11:26:40 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Apply started.
</span></span><span class=line><span class=cl>2022-03-29 11:26:40 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Using dir &lt;.devstream&gt; to store plugins.
</span></span><span class=line><span class=cl>2022-03-29 11:26:40 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Tool my-file <span class=o>(</span>localfile<span class=o>)</span> drifted from the state, will be updated.
</span></span><span class=line><span class=cl>2022-03-29 11:26:40 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Start executing the plan.
</span></span><span class=line><span class=cl>2022-03-29 11:26:40 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Changes count: 1.
</span></span><span class=line><span class=cl>2022-03-29 11:26:40 ℹ <span class=o>[</span>INFO<span class=o>]</span>  -------------------- <span class=o>[</span>  Processing progress: 1/1.  <span class=o>]</span> --------------------
</span></span><span class=line><span class=cl>2022-03-29 11:26:40 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Processing: my-file <span class=o>(</span>localfile<span class=o>)</span> -&gt; Update ...
</span></span><span class=line><span class=cl>2022-03-29 11:26:40 ✔ <span class=o>[</span>SUCCESS<span class=o>]</span>  Plugin my-file<span class=o>(</span>localfile<span class=o>)</span> Update <span class=k>done</span>.
</span></span><span class=line><span class=cl>2022-03-29 11:26:40 ℹ <span class=o>[</span>INFO<span class=o>]</span>  -------------------- <span class=o>[</span>  Processing <span class=k>done</span>.  <span class=o>]</span> --------------------
</span></span><span class=line><span class=cl>2022-03-29 11:26:40 ✔ <span class=o>[</span>SUCCESS<span class=o>]</span>  All plugins applied successfully.
</span></span><span class=line><span class=cl>2022-03-29 11:26:40 ✔ <span class=o>[</span>SUCCESS<span class=o>]</span>  Apply finished.
</span></span></code></pre></div><p>We can see that the file has drifted from the state, so it will be updated. After the operation, the file&rsquo;s content is changed back to what we defined in our config.</p><p>Heck, let&rsquo;s even try deleting this file and see what happens:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ rm foo.txt
</span></span><span class=line><span class=cl>$ ./dtm -y apply -f config-localfile-test.yaml
</span></span><span class=line><span class=cl>2022-03-29 11:27:33 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Apply started.
</span></span><span class=line><span class=cl>2022-03-29 11:27:33 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Using dir &lt;.devstream&gt; to store plugins.
</span></span><span class=line><span class=cl>2022-03-29 11:27:33 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Tool my-file <span class=o>(</span>localfile<span class=o>)</span> state found but it seems the tool isn<span class=err>&#39;</span>t created, will be created.
</span></span><span class=line><span class=cl>2022-03-29 11:27:33 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Start executing the plan.
</span></span><span class=line><span class=cl>2022-03-29 11:27:33 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Changes count: 1.
</span></span><span class=line><span class=cl>2022-03-29 11:27:33 ℹ <span class=o>[</span>INFO<span class=o>]</span>  -------------------- <span class=o>[</span>  Processing progress: 1/1.  <span class=o>]</span> --------------------
</span></span><span class=line><span class=cl>2022-03-29 11:27:33 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Processing: my-file <span class=o>(</span>localfile<span class=o>)</span> -&gt; Create ...
</span></span><span class=line><span class=cl>2022-03-29 11:27:33 ✔ <span class=o>[</span>SUCCESS<span class=o>]</span>  Plugin my-file<span class=o>(</span>localfile<span class=o>)</span> Create <span class=k>done</span>.
</span></span><span class=line><span class=cl>2022-03-29 11:27:33 ℹ <span class=o>[</span>INFO<span class=o>]</span>  -------------------- <span class=o>[</span>  Processing <span class=k>done</span>.  <span class=o>]</span> --------------------
</span></span><span class=line><span class=cl>2022-03-29 11:27:33 ✔ <span class=o>[</span>SUCCESS<span class=o>]</span>  All plugins applied successfully.
</span></span><span class=line><span class=cl>2022-03-29 11:27:33 ✔ <span class=o>[</span>SUCCESS<span class=o>]</span>  Apply finished.
</span></span></code></pre></div><p>Apparently, DevStream thought the file should exist according to the state, but it doesn&rsquo;t, so it is created again.</p><p>Last, let&rsquo;s try to <code>delete</code> this file with <code>dtm</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ./dtm -y delete -f config-localfile-test.yaml
</span></span><span class=line><span class=cl>2022-03-29 11:32:24 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Delete started.
</span></span><span class=line><span class=cl>2022-03-29 11:32:24 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Using dir &lt;.devstream&gt; to store plugins.
</span></span><span class=line><span class=cl>2022-03-29 11:32:24 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Tool my-file <span class=o>(</span>localfile<span class=o>)</span> will be deleted.
</span></span><span class=line><span class=cl>2022-03-29 11:32:24 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Start executing the plan.
</span></span><span class=line><span class=cl>2022-03-29 11:32:24 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Changes count: 1.
</span></span><span class=line><span class=cl>2022-03-29 11:32:24 ℹ <span class=o>[</span>INFO<span class=o>]</span>  -------------------- <span class=o>[</span>  Processing progress: 1/1.  <span class=o>]</span> --------------------
</span></span><span class=line><span class=cl>2022-03-29 11:32:24 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Processing: my-file <span class=o>(</span>localfile<span class=o>)</span> -&gt; Delete ...
</span></span><span class=line><span class=cl>2022-03-29 11:32:24 ℹ <span class=o>[</span>INFO<span class=o>]</span>  Prepare to delete <span class=s1>&#39;my-file_localfile&#39;</span> from States.
</span></span><span class=line><span class=cl>2022-03-29 11:32:24 ✔ <span class=o>[</span>SUCCESS<span class=o>]</span>  Plugin my-file <span class=o>(</span>localfile<span class=o>)</span> delete <span class=k>done</span>.
</span></span><span class=line><span class=cl>2022-03-29 11:32:24 ℹ <span class=o>[</span>INFO<span class=o>]</span>  -------------------- <span class=o>[</span>  Processing <span class=k>done</span>.  <span class=o>]</span> --------------------
</span></span><span class=line><span class=cl>2022-03-29 11:32:24 ✔ <span class=o>[</span>SUCCESS<span class=o>]</span>  All plugins deleted successfully.
</span></span><span class=line><span class=cl>2022-03-29 11:32:24 ✔ <span class=o>[</span>SUCCESS<span class=o>]</span>  Delete finished.
</span></span></code></pre></div><p>Hooray!</p><h2 id=summary>Summary</h2><p>I&rsquo;m sorry that I put the &ldquo;TL;DR&rdquo; at the end; it&rsquo;s only because I want you to have a global feeling of DevStream. But for advanced developers, here&rsquo;s a &ldquo;TL;DR&rdquo; (or use it as a checklist) for you:</p><ul><li>Run <code>dtm develop create-plugin --name=your-plugin</code>.</li><li>Do a <code>git status</code>, then:<ul><li>find the generated files</li><li>edit/code at the places where there is already a comment mark</li></ul></li><li>Pay special attention to the return value of the interfaces. Figure out the relationship between <em>State</em> and <em>Resource</em>. What the interfaces return decides how this plugin will behave.</li><li>Last but not least, update the documentation.</li></ul><p>If you enjoy reading this post, please like, comment, and subscribe! I will see you next time.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-03-29</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://www.guotiexin.com/posts/creating-a-dtm-plugin-for-anything/ data-title="Creating a DevStream (dtm) Plugin for Anything" data-hashtags=devstream><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://www.guotiexin.com/posts/creating-a-dtm-plugin-for-anything/ data-hashtag=devstream><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://www.guotiexin.com/posts/creating-a-dtm-plugin-for-anything/ data-title="Creating a DevStream (dtm) Plugin for Anything"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://www.guotiexin.com/posts/creating-a-dtm-plugin-for-anything/ data-title="Creating a DevStream (dtm) Plugin for Anything"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://www.guotiexin.com/posts/creating-a-dtm-plugin-for-anything/ data-title="Creating a DevStream (dtm) Plugin for Anything"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/devstream/>devstream</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/hello-world/ class=prev rel=prev title="Hello, World!"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Hello, World!</a>
<a href=/posts/dagger-in-depth/ class=next rel=next title="Dagger (the CI/CD Tool, not the Knife) In-Depth - Everything You Need to Know (as of Apr 2022)">Dagger (the CI/CD Tool, not the Knife) In-Depth - Everything You Need to Know (as of Apr 2022)<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Copyright: Tiexin Guo | CC BY-NC 4.0</div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>